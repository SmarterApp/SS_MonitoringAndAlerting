/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.shared.monitoringalerting.domain.search;

import java.io.IOException;
import java.io.Serializable;
import java.util.List;
import java.util.Map;

import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlTransient;

import org.opentestsystem.shared.monitoringalerting.domain.MABase;
import org.opentestsystem.shared.search.domain.AbstractSearchRequest;
import org.opentestsystem.shared.search.domain.SearchResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.base.Joiner;

/**
 * The response that is returned when using the paged search UI
 * 
 * @param <D>
 */
@XmlRootElement
public class RangedSearchResponse<D> extends SearchResponse<D> implements Serializable {

    private static final long serialVersionUID = -8479916141589554052L;

    private static final Logger LOGGER = LoggerFactory.getLogger(RangedSearchResponse.class);

    private List<D> searchResults;
    private int returnCount;
    private int pageSize;
    private long totalCount;
    private String sortKey;
    private String sortDirection;
    private String nextPageUrl;
    private String prevPageUrl;
    private String minId;
    private String searchResource = "";

    @XmlTransient
    @JsonIgnore
    private Map<String, String[]> originalSearchRequest;

    public RangedSearchResponse() {
        // empty
    }

    public RangedSearchResponse(final List<D> inSearchResults, final AbstractRangedSearchRequest inOriginalSearchRequest, final long inTotalCount) {
        this.searchResults = inSearchResults;
        this.totalCount = inTotalCount;
        this.returnCount = this.searchResults.size();
        this.pageSize = inOriginalSearchRequest.getPageSize();
        this.sortKey = Joiner.on(", ").skipNulls().join(inOriginalSearchRequest.getSortKeys());
        this.sortDirection = Joiner.on(", ").skipNulls().join(inOriginalSearchRequest.getSortDirections());
        this.originalSearchRequest = inOriginalSearchRequest.getSearchCriteria();
        this.nextPageUrl = buildNextPageUrl();
        this.prevPageUrl = buildPrevPageUrl();
        this.minId = inOriginalSearchRequest.getAdditionalSearchCriteria().get("minId") != null ? inOriginalSearchRequest.getAdditionalSearchCriteria().get("minId")[0] : null;
        this.searchResource = inOriginalSearchRequest.getSearchResource();
    }

    public String getMinId() {
        return this.minId;
    }

    @Override
    public List<D> getSearchResults() {
        return this.searchResults;
    }

    @Override
    public int getReturnCount() {
        return this.returnCount;
    }

    @Override
    public int getPageSize() {
        return this.pageSize;
    }

    @Override
    public long getTotalCount() {
        return this.totalCount;
    }

    @Override
    public String getSortKey() {
        return this.sortKey;
    }

    @Override
    public String getSortDirection() {
        return this.sortDirection;
    }

    @Override
    public String getNextPageUrl() {
        return this.nextPageUrl;
    }

    @Override
    public String getPrevPageUrl() {
        return this.prevPageUrl;
    }

    private String buildUrl() {
        final StringBuilder sbuilder = new StringBuilder(this.searchResource).append('?');
        for (final String key : this.originalSearchRequest.keySet()) {
            for (final String value : this.originalSearchRequest.get(key)) {
                sbuilder.append(key).append('=').append(value).append('&');
            }
        }
        sbuilder.append(AbstractSearchRequest.PAGE_SIZE).append('=').append(getPageSize()).append('&');
        return sbuilder.toString();
    }

    private String buildNextPageUrl() {
        String finalMinId = null;
        if (this.searchResults.size() > 0) {
            final D lastResult = this.searchResults.get(this.searchResults.size() - 1);
            if (lastResult instanceof MABase) {
                finalMinId = ((MABase) lastResult).getId();
            }
        }
        return this.totalCount <= getPageSize() * (getCurrentPage() + 1) || finalMinId == null ? null : "minId=" + finalMinId;
    }

    private String buildPrevPageUrl() {
        return getCurrentPage() < 1 ? null : buildUrl() + "minId=" + this.minId;
    }

    @Override
    public String toString() {
        String returnString = "SearchResponse: ";
        try {
            returnString += new ObjectMapper().writeValueAsString(this);
        } catch (final IOException e) {
            LOGGER.error("Could not turn this object into JSON", e);
        }
        return returnString;
    }
}
